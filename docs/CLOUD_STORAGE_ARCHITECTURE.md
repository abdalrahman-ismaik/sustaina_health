# üèóÔ∏è Sustaina Health - Cloud Storage Architecture

## üìã Overview

The Sustaina Health app implements a **modular, hierarchical Firestore structure** with a **hybrid storage strategy** (local + cloud) for optimal performance and offline capabilities. This document outlines the complete cloud storage architecture and data flow patterns.

## üóÇÔ∏è Firestore Database Structure

```
üìÅ Firestore Database: sustaina_health
‚îÇ
‚îî‚îÄ‚îÄ üë• users/
    ‚îÇ
    ‚îî‚îÄ‚îÄ {userId}/ (authenticated user's UID)
        ‚îÇ
        ‚îú‚îÄ‚îÄ üèãÔ∏è exercise/
        ‚îÇ   ‚îî‚îÄ‚îÄ data/
        ‚îÇ       ‚îú‚îÄ‚îÄ workouts/
        ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ {workoutId}/
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ id: string
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ name: string
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ exercises: array
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ duration: number
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ createdAt: timestamp
        ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ updatedAt: timestamp
        ‚îÇ       ‚îÇ
        ‚îÇ       ‚îú‚îÄ‚îÄ exercise_history/
        ‚îÇ       ‚îî‚îÄ‚îÄ fitness_goals/
        ‚îÇ
        ‚îú‚îÄ‚îÄ üçé nutrition/
        ‚îÇ   ‚îî‚îÄ‚îÄ data/
        ‚îÇ       ‚îú‚îÄ‚îÄ food_log_entries/
        ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ {entryId}/
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ id: string
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ userId: string
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ foodName: string
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ mealType: string (breakfast/lunch/dinner/snack)
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ servingSize: string
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ nutritionInfo: object
        ‚îÇ       ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ calories: number
        ‚îÇ       ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ protein: number
        ‚îÇ       ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ carbs: number
        ‚îÇ       ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ fat: number
        ‚îÇ       ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ fiber: number
        ‚îÇ       ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ sugar: number
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ sustainabilityScore: string
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ notes: string
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ loggedAt: timestamp
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ imageUrl: string
        ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ updatedAt: timestamp
        ‚îÇ       ‚îÇ
        ‚îÇ       ‚îú‚îÄ‚îÄ meal_plans/
        ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ {planId}/
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ name: string
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ description: string
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ meals: array
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ totalCalories: number
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ createdAt: timestamp
        ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ updatedAt: timestamp
        ‚îÇ       ‚îÇ
        ‚îÇ       ‚îú‚îÄ‚îÄ nutrition_goals/
        ‚îÇ       ‚îî‚îÄ‚îÄ nutrition_insights/
        ‚îÇ
        ‚îú‚îÄ‚îÄ üë§ profile/
        ‚îÇ   ‚îî‚îÄ‚îÄ data/
        ‚îÇ       ‚îú‚îÄ‚îÄ personal_info/
        ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ current/
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ weight: double (kg)
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ height: int (cm)
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ age: int (years)
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ sex: string (Male/Female/Other)
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ fitnessGoal: string
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ workoutsPerWeek: int
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ availableEquipment: array[string]
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ activityLevel: string
        ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ updatedAt: timestamp
        ‚îÇ       ‚îÇ
        ‚îÇ       ‚îú‚îÄ‚îÄ health_goals/
        ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ {goalId}/
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ type: string
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ target: number
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ current: number
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ deadline: timestamp
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ createdAt: timestamp
        ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ updatedAt: timestamp
        ‚îÇ       ‚îÇ
        ‚îÇ       ‚îú‚îÄ‚îÄ preferences/
        ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ {prefId}/
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ category: string
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ settings: object
        ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ createdAt: timestamp
        ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ updatedAt: timestamp
        ‚îÇ       ‚îÇ
        ‚îÇ       ‚îî‚îÄ‚îÄ achievements/
        ‚îÇ           ‚îî‚îÄ‚îÄ {achievementId}/
        ‚îÇ               ‚îú‚îÄ‚îÄ type: string
        ‚îÇ               ‚îú‚îÄ‚îÄ title: string
        ‚îÇ               ‚îú‚îÄ‚îÄ description: string
        ‚îÇ               ‚îú‚îÄ‚îÄ earnedAt: timestamp
        ‚îÇ               ‚îî‚îÄ‚îÄ createdAt: timestamp
        ‚îÇ
        ‚îî‚îÄ‚îÄ üò¥ sleep/
            ‚îî‚îÄ‚îÄ data/
                ‚îú‚îÄ‚îÄ sleep_records/
                ‚îÇ   ‚îî‚îÄ‚îÄ {recordId}/
                ‚îÇ       ‚îú‚îÄ‚îÄ bedTime: timestamp
                ‚îÇ       ‚îú‚îÄ‚îÄ wakeTime: timestamp
                ‚îÇ       ‚îú‚îÄ‚îÄ duration: number
                ‚îÇ       ‚îú‚îÄ‚îÄ quality: number
                ‚îÇ       ‚îú‚îÄ‚îÄ createdAt: timestamp
                ‚îÇ       ‚îî‚îÄ‚îÄ updatedAt: timestamp
                ‚îÇ
                ‚îú‚îÄ‚îÄ sleep_goals/
                ‚îî‚îÄ‚îÄ sleep_insights/
```

## üèõÔ∏è Architecture Components

### Service Layer Architecture

```mermaid
graph TD
    A[üì± Profile Home Screen] --> B[üîÄ HybridProfileService]
    B --> C[üì± Local: SharedPreferences]
    B --> D[‚òÅÔ∏è Cloud: FirestoreProfileService]
    D --> E[üóÑÔ∏è Firestore Database]
    
    F[üì± Nutrition Screen] --> G[üîÄ NutritionRepository]
    G --> H[üì± Local: SharedPreferences]
    G --> I[‚òÅÔ∏è Cloud: FirestoreNutritionService]
    I --> E
```

### Data Models

#### UserProfile Model
```dart
class UserProfile {
  final double? weight;              // Body weight in kg
  final int? height;                // Height in cm  
  final int? age;                   // Age in years
  final String? sex;                // Male/Female/Other
  final String? fitnessGoal;        // Weight loss, muscle gain, etc.
  final int? workoutsPerWeek;       // Exercise frequency per week
  final List<String> availableEquipment; // Home gym equipment list
  final String? activityLevel;      // Sedentary, lightly active, etc.
  
  // Conversion methods
  factory UserProfile.fromJson(Map<String, dynamic> json);
  Map<String, dynamic> toJson();
}
```

#### FoodLogEntry Model
```dart
class FoodLogEntry {
  final String id;                  // Unique identifier
  final String userId;              // User who logged the food
  final String foodName;            // Name of the food item
  final String mealType;            // breakfast/lunch/dinner/snack
  final String servingSize;         // Serving size description
  final NutritionInfo nutritionInfo; // Detailed nutrition data
  final String? sustainabilityScore; // Environmental impact score
  final String? notes;              // User notes
  final DateTime loggedAt;          // When the food was logged
  final String? imageUrl;           // Optional food image
}
```

### Service Responsibilities

| Service | Purpose | Storage Type | Key Methods |
|---------|---------|--------------|-------------|
| **FirestoreProfileService** | Pure cloud operations | Firestore only | `savePersonalInfo()`, `getPersonalInfo()` |
| **HybridProfileService** | Dual storage management | Local + Cloud | `saveUserProfile()`, `getUserProfile()` |
| **FirestoreNutritionService** | Nutrition cloud ops | Firestore only | `saveFoodLogEntry()`, `getFoodLogEntries()` |
| **NutritionRepositoryImpl** | Nutrition hybrid storage | Local + Cloud | Handles deduplication, sync |

## üîÑ Data Flow Architecture

### Save Operation Flow

```mermaid
sequenceDiagram
    participant UI as User Interface
    participant HS as HybridService
    participant LS as Local Storage
    participant FS as Firestore Service
    participant FB as Firestore DB
    
    UI->>HS: saveUserProfile(profile)
    HS->>LS: _saveProfileLocally(profile)
    LS-->>HS: Success
    HS->>FS: savePersonalInfo(profile)
    FS->>FB: users/{userId}/profile/data/personal_info/current
    FB-->>FS: Success
    FS-->>HS: Success
    HS-->>UI: ‚úÖ Saved to both local and cloud
```

### Load Operation Flow

```mermaid
sequenceDiagram
    participant UI as User Interface
    participant HS as HybridService
    participant FS as Firestore Service
    participant LS as Local Storage
    participant FB as Firestore DB
    
    UI->>HS: getUserProfile()
    HS->>FS: getPersonalInfo()
    FS->>FB: users/{userId}/profile/data/personal_info/current
    
    alt Cloud data exists
        FB-->>FS: Profile data
        FS-->>HS: Profile data
        HS->>LS: _saveProfileLocally(profile)
        HS-->>UI: ‚úÖ Cloud data (synced to local)
    else Cloud fails/no data
        HS->>LS: _getProfileLocally()
        LS-->>HS: Local profile data
        HS-->>UI: üìÅ Local data (fallback)
    end
```

## üìç Storage Paths and Keys

### Firestore Collection Paths

| Module | Firestore Path | Purpose |
|--------|----------------|---------|
| **Profile** | `users/{userId}/profile/data/personal_info/current` | User's personal information |
| **Nutrition** | `users/{userId}/nutrition/data/food_log_entries/{entryId}` | Individual food log entries |
| **Nutrition** | `users/{userId}/nutrition/data/meal_plans/{planId}` | Saved meal plans |
| **Exercise** | `users/{userId}/exercise/data/workouts/{workoutId}` | Workout records |
| **Sleep** | `users/{userId}/sleep/data/sleep_records/{recordId}` | Sleep tracking data |

### Local Storage Keys

| Module | SharedPreferences Key | Purpose |
|--------|-----------------------|---------|
| **Profile** | `user_profile` | Serialized UserProfile JSON |
| **Profile** | `profile_weight`, `profile_height`, `profile_age`, `profile_sex` | Individual profile fields (legacy) |
| **Nutrition** | `food_log_entries` | Array of food log JSON strings |
| **Nutrition** | `meal_plans` | Array of meal plan JSON strings |

## ‚ö° Key Features

### 1. Hybrid Storage Strategy

#### Benefits
- **üì± Local First**: Always save to SharedPreferences first for immediate access
- **‚òÅÔ∏è Cloud Sync**: Automatically sync to Firestore when online
- **üîå Offline Support**: App works without internet connection
- **üîÑ Smart Fallback**: Uses local data if cloud fails

#### Implementation
```dart
Future<void> saveUserProfile(UserProfile profile) async {
  try {
    // Always save locally first
    await _saveProfileLocally(profile);
    
    // Save to cloud if user is signed in
    if (_isUserSignedIn) {
      try {
        await _firestoreService.ensureProfileModuleExists();
        await _firestoreService.savePersonalInfo(profile);
        print('‚úÖ Saved to both local storage and Firestore cloud!');
      } catch (e) {
        print('Cloud save failed, but local save succeeded: $e');
      }
    }
  } catch (e) {
    throw Exception('Failed to save user profile: $e');
  }
}
```

### 2. Modular Design

#### Structure Benefits
- **üèóÔ∏è Isolated Modules**: Each feature has its own Firestore subcollection
- **üìê Consistent Structure**: All modules follow same `/data/` pattern
- **üìà Scalable**: Easy to add new features without affecting existing data
- **üîß Maintainable**: Clear separation of concerns

#### Module Pattern
```
users/{userId}/{module}/data/{subcollection}/{documentId}
```

Examples:
- `users/abc123/profile/data/personal_info/current`
- `users/abc123/nutrition/data/food_log_entries/xyz789`
- `users/abc123/exercise/data/workouts/def456`

### 3. Data Integrity & Security

#### Timestamp Management
- **createdAt**: Server timestamp when document is first created
- **updatedAt**: Server timestamp on every update
- **loggedAt**: User-specific timestamps for time-sensitive data

#### Security Features
- **üë§ User Isolation**: Each user's data is completely separate
- **üîê Authentication Required**: All operations require valid Firebase Auth
- **üõ°Ô∏è Type Safety**: Strong typing with Dart models
- **üö´ No Cross-User Access**: Firestore rules prevent access to other users' data

#### Error Handling
```dart
try {
  await _firestoreService.savePersonalInfo(profile);
  print('‚úÖ Personal info saved to cloud storage');
} catch (e) {
  print('‚ùå Error saving to cloud: $e');
  // Graceful degradation - local storage still works
  await _saveProfileLocally(profile);
  print('üìÅ Saved to local storage (fallback)');
}
```

### 4. Deduplication & Performance

#### Nutrition Module Deduplication
- **30-second window**: Prevents duplicate food entries within 30 seconds
- **Unique key generation**: Based on food name, calories, and timestamp
- **Memory efficient**: Automatic cleanup of deduplication cache

```dart
// Create unique key for deduplication
final String dedupeKey = '${entry.foodName}_${entry.nutritionInfo.calories}_${entry.loggedAt.millisecondsSinceEpoch}';

// Check if recently saved
if (_recentlySaved.contains(dedupeKey)) {
  print('üîÑ Skipping duplicate save for "${entry.foodName}" - already saved recently');
  return entry.id;
}
```

## üöÄ Recent Enhancements

### Personal Details Integration
- ‚úÖ **Cloud Storage**: Personal details now save to Firestore
- ‚úÖ **Auto-Sync**: Background sync on app startup  
- ‚úÖ **Manual Sync**: User-triggered sync with loading states
- ‚úÖ **Deduplication**: Prevents duplicate saves within 30 seconds
- ‚úÖ **Error Recovery**: Graceful handling of network issues

### UI Improvements
- ‚úÖ **Safe Dialogs**: Prevents black screen issues with proper context management
- ‚úÖ **Loading States**: Visual feedback during sync operations
- ‚úÖ **No Back Arrow**: Clean profile screen navigation
- ‚úÖ **Success Feedback**: Toast messages for user actions

### Console Logging
- `‚úÖ Personal info loaded from cloud storage` - Data loaded from Firestore
- `üìÅ Personal info loaded from local storage (fallback)` - Using local data
- `‚úÖ Personal info saved to both local storage and Firestore cloud!` - Successful save
- `üîÑ Successfully synced local personal data to cloud storage` - Manual sync worked
- `üîÑ Skipping duplicate save` - Deduplication prevented duplicate entry

## üîß Technical Implementation

### Authentication Flow
```dart
String get _userId {
  final User? user = _auth.currentUser;
  if (user == null) {
    throw Exception('User not authenticated');
  }
  return user.uid;
}
```

### Module Initialization
```dart
Future<void> ensureProfileModuleExists() async {
  final DocumentReference profileDoc = _firestore
      .collection('users')
      .doc(_userId)
      .collection('profile')
      .doc('data');
  
  final DocumentSnapshot doc = await profileDoc.get();
  if (!doc.exists) {
    await profileDoc.set({
      'module': 'profile',
      'createdAt': FieldValue.serverTimestamp(),
      'lastUpdated': FieldValue.serverTimestamp(),
    });
  }
}
```

### Collection References
```dart
CollectionReference get _personalInfoCollection =>
    _firestore.collection('users')
             .doc(_userId)
             .collection('profile')
             .doc('data')
             .collection('personal_info');
```

## üìä Benefits Summary

| Feature | Benefit | Implementation |
|---------|---------|----------------|
| **Hybrid Storage** | Offline capability + Cloud sync | Local + Firestore |
| **Modular Structure** | Scalable, maintainable code | Feature-based collections |
| **Type Safety** | Fewer runtime errors | Dart model classes |
| **Deduplication** | Prevents data pollution | In-memory cache with cleanup |
| **Error Handling** | Graceful degradation | Try-catch with fallbacks |
| **User Isolation** | Data privacy & security | User-scoped collections |
| **Real-time Sync** | Cross-device consistency | Firestore real-time updates |

This architecture ensures your personal details and all app data are **safely stored in the cloud**, **synchronized across devices**, and **always accessible offline**! üéâ

---

*Last updated: September 5, 2025*  
*Version: 2.0.0*  
*Author: Sustaina Health Development Team*
